<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
    <title>More Internet Clutter | Django internals - Request/Response stack</title>
    <link rel="shortcut icon" type="image/png" href="https://chanhosuh.github.io/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="https://chanhosuh.github.io/favicon.ico">
    <link href="https://chanhosuh.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="More Internet Clutter Full Atom Feed" />
    <link href="https://chanhosuh.github.io/feeds/django-python-wsgi-rest.atom.xml" type="application/atom+xml" rel="alternate" title="More Internet Clutter Categories Atom Feed" />
    <link rel="stylesheet" href="https://chanhosuh.github.io/theme/css/screen.css" type="text/css" />
    <link rel="stylesheet" href="https://chanhosuh.github.io/theme/css/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://chanhosuh.github.io/theme/css/print.css" type="text/css" media="print" />
    <meta name="generator" content="Pelican" />

</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/pages/about-me.html">About Me</a></li>
                <li><a href="https://chanhosuh.github.io/archives">Blog</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href="https://chanhosuh.github.io">More Internet Clutter</a></h1>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Sep 01, 2018</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://chanhosuh.github.io/drafts/django-internals-requestresponse-stack.html" rel="bookmark" title="Permanent Link to &quot;Django internals - Request/Response stack&quot;">Django internals - Request/Response stack</a>
                </h2>

                <p>A benefit of using a web framework like Django is it does so many things out of the box for you.  The big disadvantage, of course, is that one day something mysterious will happen, and you have no idea why.  For me, one of the things that has come to bite me a few times, particularly during unit tests, is understanding exactly how requests get propagated through Django's middleware chain, gets processed by the view(s), and returns a response which continues through the rest of the middleware.</p>
<p>The implementation turns out to be fairly straighforward, but it does involve knowing a bit about WSGI, and understanding Django's view &amp; template interaction.</p>
<p>For reference, my code snippets are from Django 2.1, but this part of the codebase hasn't changed much for some years.</p>
<h2>WSGI</h2>
<p>Let's start with a quick summary of the Web Server Gateway Interface (WSGI).  For a readable intro with more details and rationale behind the standards, I would just recommend reading <a href="https://www.python.org/dev/peps/pep-0333/">PEP 333</a>.</p>
<p>WSGI is a standard which prescribes an interface for interaction between a web server and a Python application, typically a web framework like Django, Flask, etc.  Two popular implementations of WSGI are uWSGI and Gunicorn. </p>
<p>Essentially, a web server either runs a WSGI implementation, or connects to it if they are in separate containers.  The WSGI implementation runs a Python process which imports a callable provided by the Python application and invokes it upon every request.</p>
<p>Thus WSGI requires:</p>
<ul>
<li>the application callable:  </li>
</ul>
<p><code>python
  def simple_app(environ, start_response):
      """Simplest possible application object"""
      status = '200 OK'
      response_headers = [('Content-type', 'text/plain')]
      start_response(status, response_headers)
      return ['Hello world!\n']</code></p>
<p>The example uses a function to demonstrate the signature, but the callable can be any Python object with a <code>__call__</code> method with the same signature.  </p>
<ul>
<li><code>environ</code>: a dictionary of environment variables, e.g. REQUEST_METHOD, PATH_INFO, QUERY_STRING, etc.  </li>
<li><code>start_response</code>: a Python callable provided by the WSGI implementation.  More below.  </li>
<li>
<p>The return value must be an iterable of strings.</p>
</li>
<li>
<p>Its own callable, <code>start_response</code>, which it hands off to the application.  Its arguments are:</p>
</li>
<li><code>status</code>: a string giving status code and reason</li>
<li><code>response_headers</code>: a list of valid header key-value pairs</li>
</ul>
<p>I won't say much more on this, as it's not needed.  Consult the PEP for futher details.</p>
<h3>WSGIHandler</h3>
<p>When you run a WSGI implementation like <code>gunicorn</code>, you will give it the path to the Django WSGI app object, which is in a module in your project called <code>wsgi.py</code>.  It will have something like this in it:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">django.core.wsgi</span> <span class="kn">import</span> <span class="n">get_wsgi_application</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span class="p">,</span> <span class="s2">&quot;my_project.settings&quot;</span><span class="p">)</span>
<span class="n">application</span> <span class="o">=</span> <span class="n">get_wsgi_application</span><span class="p">()</span>
</pre></div>


<p>If you dig in the source code you find:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">django</span>
<span class="kn">from</span> <span class="nn">django.core.handlers.wsgi</span> <span class="kn">import</span> <span class="n">WSGIHandler</span>

<span class="k">def</span> <span class="nf">get_wsgi_application</span><span class="p">():</span>
    <span class="n">django</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">set_prefix</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">WSGIHandler</span><span class="p">()</span>
</pre></div>


<p>So the WSGI callable is <code>WSGIHandler</code>.  Let's look at its <code>__call__</code> method.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="p">[</span><span class="o">...</span> <span class="n">snipped</span> <span class="o">...</span><span class="p">]</span>

    <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_class</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="p">[</span><span class="o">...</span> <span class="n">snipped</span> <span class="o">...</span><span class="p">]</span>

    <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>

    <span class="p">[</span><span class="o">...</span> <span class="n">snipped</span> <span class="o">...</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">response</span>
</pre></div>


<p>We aren't going to worry about the <code>start_response</code> stuff, but I left that line in there so you can see that <code>WSGIHandler</code> does indeed follow the WSGI protocol.  </p>
<p>The part that is important for us is the creation of the request object and then the call to <code>get_response</code> which produces the response from the request.</p>
<h3>WSGIRequest</h3>
<p>The <code>WSGIHandler</code> code starts off with:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WSGIHandler</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="n">request_class</span> <span class="o">=</span> <span class="n">WSGIRequest</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_middleware</span><span class="p">()</span>
</pre></div>


<p>So you see that the line from <code>__call__</code> above:</p>
<div class="highlight"><pre><span></span>   <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_class</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
</pre></div>


<p>just creates a <code>WSGIRequest</code> instance from <code>environ</code>, which, remember, is just a dictionary of environment variables, including the information the web server has about the request.</p>
<p>Also notice that the <code>__init__</code> does a mysterious <code>load_middleware()</code>.  More on that later.</p>
<p>What happens inside the <code>__init__</code> for <code>WSGIRequest</code> isn't too interesting for us; the key takeaway is that the <code>path</code>, <code>method</code>, and <code>resolve_match</code> attributes are set.  The first two give a cleaned URL and method name like <code>GET</code>, resp.  The last is set to <code>None</code> and will be changed by the URL resolution part of the middleware chain.</p>
<h2>Middleware chain</h2>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="c1"># Setup default url resolver for this thread</span>
    <span class="n">set_urlconf</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">ROOT_URLCONF</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_middleware_chain</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="p">[</span><span class="o">...</span> <span class="n">snipped</span> <span class="o">...</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">response</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="p">[</span> <span class="o">...</span> <span class="n">resolve</span> <span class="ow">and</span> <span class="nb">set</span> <span class="n">path</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">callback</span><span class="p">,</span> <span class="n">callback_args</span><span class="p">,</span> <span class="n">callback_kwargs</span> <span class="o">=</span> <span class="n">resolver_match</span>
    <span class="n">request</span><span class="o">.</span><span class="n">resolver_match</span> <span class="o">=</span> <span class="n">resolver_match</span>

    <span class="c1"># Apply view middleware</span>
    <span class="k">for</span> <span class="n">middleware_method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_view_middleware</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">middleware_method</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">callback_args</span><span class="p">,</span> <span class="n">callback_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="p">[</span><span class="o">...</span> <span class="n">snip</span> <span class="n">exception</span> <span class="n">handling</span> <span class="o">...</span><span class="p">]</span>

    <span class="p">[</span><span class="o">...</span> <span class="n">snip</span> <span class="n">deferred</span> <span class="n">rendering</span> <span class="o">...</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">response</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_middleware</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_view_middleware</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_template_response_middleware</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_exception_middleware</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">handler</span> <span class="o">=</span> <span class="n">convert_exception_to_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_response</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">middleware_path</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIDDLEWARE</span><span class="p">):</span>
        <span class="n">middleware</span> <span class="o">=</span> <span class="n">import_string</span><span class="p">(</span><span class="n">middleware_path</span><span class="p">)</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">middleware</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="p">[</span><span class="o">...</span> <span class="n">exception</span> <span class="n">handling</span> <span class="n">snipped</span> <span class="o">...</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s1">&#39;process_view&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_view_middleware</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">handler</span><span class="o">.</span><span class="n">process_view</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s1">&#39;process_template_response&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_template_response_middleware</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">process_template_response</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s1">&#39;process_exception&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exception_middleware</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">process_exception</span><span class="p">)</span>

        <span class="n">handler</span> <span class="o">=</span> <span class="n">convert_exception_to_response</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_middleware_chain</span> <span class="o">=</span> <span class="n">handler</span>
</pre></div>


<h2></h2>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://chanhosuh.github.io/drafts/django-internals-requestresponse-stack.html">posted at 00:00</a>
                    &nbsp;&middot;&nbsp;<a href="https://chanhosuh.github.io/category/django-python-wsgi-rest.html" rel="tag">Django, Python, WSGI, REST</a>
                </div>
            </article>
            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
                &middot;
                <a href="https://chanhosuh.github.io/feeds/all.atom.xml" rel="alternate">Atom Feed</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
</body>
</html>